#!/usr/bin/env bash
# CustomPiOS chroot_script — runs INSIDE the image at build time.
# Installs AxleLore, Ollama, models, knowledge pack, and system services.
set -euo pipefail

echo ">>> AxleLore chroot_script: begin"

# ──────────────────────────────────────────────
# 1. System packages
# ──────────────────────────────────────────────
apt-get update
apt-get install -y --no-install-recommends \
    python3 python3-venv python3-pip python3-dev \
    git curl wget avahi-daemon avahi-utils \
    bluez libglib2.0-dev libdbus-1-dev \
    network-manager dnsmasq \
    cage chromium-browser \
    plymouth plymouth-themes \
    watchdog \
    gpg
apt-get clean

# Enable NetworkManager (needed for wifi-connect)
systemctl enable NetworkManager
systemctl disable dhcpcd 2>/dev/null || true

# ──────────────────────────────────────────────
# 2. Create axlelore user
# ──────────────────────────────────────────────
if ! id -u "${AXLELORE_USER}" &>/dev/null; then
    useradd -r -m -d /home/${AXLELORE_USER} -s /bin/bash "${AXLELORE_USER}"
    usermod -aG dialout,bluetooth "${AXLELORE_USER}"
fi

# ──────────────────────────────────────────────
# 3. Install application
# ──────────────────────────────────────────────
mkdir -p "${AXLELORE_INSTALL_DIR}"

# Source code and configs are placed by the filesystem/ layer
# (build-image.sh copies the repo tree into filesystem/opt/axlelore/)

python3 -m venv "${AXLELORE_VENV_DIR}"
"${AXLELORE_VENV_DIR}/bin/pip" install --upgrade pip wheel setuptools
"${AXLELORE_VENV_DIR}/bin/pip" install -e "${AXLELORE_INSTALL_DIR}"

# Pre-cache the embedding model so first boot needs no internet
"${AXLELORE_VENV_DIR}/bin/python" -c "
from sentence_transformers import SentenceTransformer
SentenceTransformer('${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}')
print('Embedding model cached')
"

# ──────────────────────────────────────────────
# 4. Install Ollama
# ──────────────────────────────────────────────
curl -fsSL https://ollama.ai/install.sh | sh

# Pull models (Ollama must be running)
ollama serve &
OLLAMA_PID=$!
sleep 5

ollama pull "${OLLAMA_MODEL:-qwen3:1.7b}"
if [[ "${PULL_FALLBACK:-yes}" == "yes" ]]; then
    ollama pull "${OLLAMA_FALLBACK_MODEL:-gemma3:1b}"
fi

kill $OLLAMA_PID 2>/dev/null || true
wait $OLLAMA_PID 2>/dev/null || true

# ──────────────────────────────────────────────
# 5. Create data directories
# ──────────────────────────────────────────────
mkdir -p "${AXLELORE_DATA_DIR}"/{db,chromadb,logs/{chat,obd2},vehicles}

# Knowledge-pack data is placed by filesystem/ layer into
# /opt/axlelore/data/chromadb/

# ──────────────────────────────────────────────
# 6. Production .env
# ──────────────────────────────────────────────
cat > "${AXLELORE_INSTALL_DIR}/.env" <<DOTENV
APP_NAME=AxleLore
DEBUG=false
API_HOST=0.0.0.0
API_PORT=8000
API_RELOAD=false
OLLAMA_HOST=http://localhost:11434
OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:1.7b}
OLLAMA_FALLBACK_MODEL=${OLLAMA_FALLBACK_MODEL:-gemma3:1b}
LLM_TEMPERATURE=0.4
LLM_MAX_TOKENS=1024
EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
CHUNK_SIZE=600
CHUNK_OVERLAP=100
RETRIEVAL_TOP_K=5
SIMILARITY_THRESHOLD=0.65
OBD2_ENABLED=false
DEFAULT_VEHICLE=${VEHICLE_TYPE:-fzj80}
LOG_LEVEL=WARNING
CORS_ORIGINS=["http://localhost:8000"]
DOTENV

# ──────────────────────────────────────────────
# 7. Install wifi-connect (captive portal)
# ──────────────────────────────────────────────
WIFI_CONNECT_TAG="${WIFI_CONNECT_VERSION:-4.11.35}"
WIFI_CONNECT_URL="https://github.com/balena-os/wifi-connect/releases/download/v${WIFI_CONNECT_TAG}/wifi-connect-v${WIFI_CONNECT_TAG}-linux-aarch64.tar.gz"

mkdir -p /opt/wifi-connect
wget -qO- "${WIFI_CONNECT_URL}" | tar xz -C /opt/wifi-connect

# ──────────────────────────────────────────────
# 8. Install systemd units
# ──────────────────────────────────────────────

# --- AxleLore main service ---
cat > /etc/systemd/system/axlelore.service <<'UNIT'
[Unit]
Description=AxleLore Vehicle Assistant
After=network-online.target ollama.service
Wants=network-online.target

[Service]
Type=simple
User=axlelore
WorkingDirectory=/opt/axlelore
Environment="PYTHONPATH=/opt/axlelore/src"
Environment="PATH=/opt/axlelore/.venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/opt/axlelore/.venv/bin/python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000 --log-level warning
Restart=always
RestartSec=10
StartLimitIntervalSec=300
StartLimitBurst=5

[Install]
WantedBy=multi-user.target
UNIT

# --- First-boot provisioning ---
cat > /etc/systemd/system/axlelore-firstboot.service <<'UNIT'
[Unit]
Description=AxleLore First-Boot Provisioning
After=network-online.target
Wants=network-online.target
ConditionPathExists=!/var/lib/axlelore/.provisioned

[Service]
Type=oneshot
User=root
ExecStart=/opt/axlelore/bin/first-boot.sh
RemainAfterExit=yes
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
UNIT

# --- WiFi-Connect captive portal (first boot only) ---
cat > /etc/systemd/system/axlelore-wifi-setup.service <<'UNIT'
[Unit]
Description=AxleLore WiFi Setup (Captive Portal)
Before=axlelore-firstboot.service
ConditionPathExists=!/var/lib/axlelore/.wifi-configured

[Service]
Type=simple
User=root
Environment="PORTAL_SSID=AxleLore-Setup"
Environment="PORTAL_GATEWAY=192.168.42.1"
ExecStart=/opt/wifi-connect/wifi-connect -s ${PORTAL_SSID} -g ${PORTAL_GATEWAY}
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
UNIT

# --- Update-check timer ---
cat > /etc/systemd/system/axlelore-update.service <<'UNIT'
[Unit]
Description=AxleLore Knowledge Pack Update Check
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
User=axlelore
ExecStart=/opt/axlelore/bin/check-update.sh
StandardOutput=journal
StandardError=journal
UNIT

cat > /etc/systemd/system/axlelore-update.timer <<'UNIT'
[Unit]
Description=Check for AxleLore knowledge-pack updates every 6 hours

[Timer]
OnBootSec=5min
OnUnitActiveSec=6h
RandomizedDelaySec=15min
Persistent=true

[Install]
WantedBy=timers.target
UNIT

# Enable services
systemctl enable axlelore.service
systemctl enable axlelore-firstboot.service
systemctl enable axlelore-wifi-setup.service
systemctl enable axlelore-update.timer

# Install NetworkManager dispatcher — trigger update check on Wi-Fi connect
cat > /etc/NetworkManager/dispatcher.d/50-axlelore-update <<'DISPATCH'
#!/bin/bash
# Trigger an update check whenever Wi-Fi connects
IFACE="$1"
ACTION="$2"
if [[ "$ACTION" == "up" && "$IFACE" == wlan* ]]; then
    systemctl start --no-block axlelore-update.service
fi
DISPATCH
chmod +x /etc/NetworkManager/dispatcher.d/50-axlelore-update

# ──────────────────────────────────────────────
# 9. Persistent Wi-Fi hotspot (AP mode)
# ──────────────────────────────────────────────
# When no known Wi-Fi is in range (i.e. in the truck), the Pi auto-creates
# an AP named AxleLore-FZJ80.  Uses NetworkManager — no hostapd needed.

cat > /opt/axlelore/bin/hotspot-manager.sh <<'HOTSPOT'
#!/bin/bash
# Wait up to 30s for a known Wi-Fi connection, then start hotspot.
set -euo pipefail
SSID="${HOTSPOT_SSID:-AxleLore-FZJ80}"
TIMEOUT=30

for i in $(seq 1 $TIMEOUT); do
    if nmcli -t -f TYPE,STATE connection show --active 2>/dev/null | grep -q "802-11-wireless:activated"; then
        echo "Wi-Fi connected, hotspot not needed"
        exit 0
    fi
    sleep 1
done

echo "No Wi-Fi found after ${TIMEOUT}s — starting hotspot: ${SSID}"
nmcli device wifi hotspot ifname wlan0 ssid "${SSID}" password "axlelore80" band bg channel 6 || true
HOTSPOT
chmod +x /opt/axlelore/bin/hotspot-manager.sh

cat > /etc/systemd/system/axlelore-hotspot.service <<'UNIT'
[Unit]
Description=AxleLore Wi-Fi Hotspot Manager
After=NetworkManager.service
Wants=NetworkManager.service

[Service]
Type=oneshot
ExecStart=/opt/axlelore/bin/hotspot-manager.sh
RemainAfterExit=yes
StandardOutput=journal

[Install]
WantedBy=multi-user.target
UNIT

systemctl enable axlelore-hotspot.service

# ──────────────────────────────────────────────
# 10. Captive portal redirect (dnsmasq)
# ──────────────────────────────────────────────
# When in hotspot mode, redirect all DNS queries to the Pi so phones
# auto-open the AxleLore UI (captive portal detection).

cat > /etc/dnsmasq.d/axlelore-captive.conf <<'DNSMASQ'
# Only active on the hotspot interface
interface=wlan0
bind-interfaces
# DHCP range for hotspot clients
dhcp-range=10.42.0.10,10.42.0.100,255.255.255.0,24h
# Redirect all DNS to Pi (captive portal)
address=/#/10.42.0.1
DNSMASQ

# Disable dnsmasq by default — NetworkManager starts it when hotspot is active
systemctl disable dnsmasq

# ──────────────────────────────────────────────
# 11. Avahi / mDNS service advertisement
# ──────────────────────────────────────────────
mkdir -p /etc/avahi/services

cat > /etc/avahi/services/axlelore.service <<'AVAHI'
<?xml version="1.0" standalone="no"?>
<!DOCTYPE service-group SYSTEM "avahi-service.dtd">
<service-group>
  <name replace-wildcards="yes">AxleLore on %h</name>
  <service>
    <type>_http._tcp</type>
    <port>8000</port>
    <txt-record>path=/</txt-record>
    <txt-record>version=0.2.0</txt-record>
  </service>
</service-group>
AVAHI

systemctl enable avahi-daemon

# ──────────────────────────────────────────────
# 12. Kiosk mode (Cage + Chromium)
# ──────────────────────────────────────────────
cat > /etc/systemd/system/axlelore-kiosk.service <<'UNIT'
[Unit]
Description=AxleLore Kiosk (Cage + Chromium)
After=axlelore.service
Wants=axlelore.service
ConditionPathExists=/usr/bin/cage

[Service]
Type=simple
User=axlelore
Environment="WLR_LIBINPUT_NO_DEVICES=1"
Environment="XDG_RUNTIME_DIR=/run/user/1000"
ExecStartPre=/bin/sleep 5
ExecStart=/usr/bin/cage -- /usr/bin/chromium-browser \
    --kiosk \
    --noerrdialogs \
    --no-first-run \
    --disable-translate \
    --disable-infobars \
    --disable-session-crashed-bubble \
    --disable-features=TranslateUI \
    --ozone-platform=wayland \
    http://localhost:8000
Restart=on-failure
RestartSec=5

[Install]
WantedBy=graphical.target
UNIT

systemctl enable axlelore-kiosk.service

# ──────────────────────────────────────────────
# 13. Plymouth boot splash
# ──────────────────────────────────────────────
mkdir -p /usr/share/plymouth/themes/axlelore

cat > /usr/share/plymouth/themes/axlelore/axlelore.plymouth <<'PLYMOUTH'
[Plymouth Theme]
Name=AxleLore
Description=AxleLore boot splash
ModuleName=script

[script]
ImageDir=/usr/share/plymouth/themes/axlelore
ScriptFile=/usr/share/plymouth/themes/axlelore/axlelore.script
PLYMOUTH

cat > /usr/share/plymouth/themes/axlelore/axlelore.script <<'SCRIPT'
# Simple AxleLore boot splash: centered text on dark background
Window.SetBackgroundTopColor(0.04, 0.05, 0.08);
Window.SetBackgroundBottomColor(0.04, 0.05, 0.08);

# Brand text
brand = Sprite();
brand_image = Image.Text("AxleLore", 0.2, 1.0, 0.2, 1, "JetBrains Mono");
brand.SetImage(brand_image);
brand.SetX(Window.GetWidth() / 2 - brand_image.GetWidth() / 2);
brand.SetY(Window.GetHeight() / 2 - 30);

# Subtitle
sub = Sprite();
sub_image = Image.Text("FZJ80 Vehicle Assistant", 0.42, 0.48, 0.55, 0.6, "JetBrains Mono");
sub.SetImage(sub_image);
sub.SetX(Window.GetWidth() / 2 - sub_image.GetWidth() / 2);
sub.SetY(Window.GetHeight() / 2 + 10);

# Spinner dots
fun refresh_callback() {
    # Simple progress indicator
}
Plymouth.SetRefreshFunction(refresh_callback);
SCRIPT

# Set as default Plymouth theme
plymouth-set-default-theme axlelore 2>/dev/null || true

# ──────────────────────────────────────────────
# 14. Read-only root filesystem (overlayfs)
# ──────────────────────────────────────────────
# Enable overlayfs for SD card longevity and crash recovery.
# Writable bind-mounts for data and state directories.
raspi-config nonint enable_overlayfs 2>/dev/null || true

# Ensure writable dirs are bind-mounted (added to fstab)
cat >> /etc/fstab <<'FSTAB'
# AxleLore writable bind-mounts (survive overlayfs)
tmpfs /tmp tmpfs defaults,noatime,nosuid,nodev,size=64M 0 0
/opt/axlelore/data /opt/axlelore/data none bind,nofail 0 0
/var/lib/axlelore /var/lib/axlelore none bind,nofail 0 0
FSTAB

# ──────────────────────────────────────────────
# 15. Hardware watchdog
# ──────────────────────────────────────────────
# Enable bcm2835_wdt kernel module
echo "bcm2835_wdt" >> /etc/modules

# Configure watchdog daemon
cat > /etc/watchdog.conf <<'WDG'
watchdog-device = /dev/watchdog
watchdog-timeout = 15
max-load-1 = 24
min-memory = 1
WDG

systemctl enable watchdog

# Add WatchdogSec to the main service for systemd-level watchdog
sed -i '/^Restart=always/a WatchdogSec=60' /etc/systemd/system/axlelore.service

# ──────────────────────────────────────────────
# 16. Set ownership
# ──────────────────────────────────────────────
chown -R "${AXLELORE_USER}:${AXLELORE_USER}" "${AXLELORE_INSTALL_DIR}"
mkdir -p /var/lib/axlelore
chown "${AXLELORE_USER}:${AXLELORE_USER}" /var/lib/axlelore

# ──────────────────────────────────────────────
# 10. Hostname
# ──────────────────────────────────────────────
echo "axlelore" > /etc/hostname
sed -i 's/127\.0\.1\.1.*/127.0.1.1\taxlelore/' /etc/hosts

echo ">>> AxleLore chroot_script: complete"
